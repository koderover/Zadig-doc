---
title: 基于现有 Kubernetes 安装
date: 2021-03-29 16:18:33
permalink: /v1.7.1/install/install-on-k8s/
---

> 在现有 Kubernetes 集群上安装 Zadig 系统正式版，推荐以 addons 的方式提供持久化存储组件，可生产使用。

## 步骤 1：准备 Kubernetes 集群

- Kubernetes  <Badge text="v1.16.0" /> 及以上版本 <br>
- Helm  <Badge text="v3.0.0 +" /> 版本<br>

::: tip 自建集群注意事项

- 在安装之前，需要配置 Kubernetes `默认`的 StorageClass，以支持创建 PVC 用于数据持久化
- 配置 kube-dns 服务，以支持服务和 Pod 之间的按名称寻址
:::

## 步骤 2：准备安装环境

- 需要一台可以正常连通该集群的机器用于执行安装脚本。
- 确保该机器已经安装了 [kubectl 客户端](https://kubernetes.io/docs/tasks/tools/) 并且可以使用管理员的权限操作该集群。

## 步骤 3：下载安装脚本

下载安装脚本并添加可执行权限。

```bash
curl -LO https://github.com/koderover/zadig/releases/latest/download/install.sh
chmod +x ./install.sh
```
若网络状况欠佳，也可使用官方脚本安装: 
```bash
curl -L https://download.koderover.com/install?type=standard -o install.sh 
chmod +x ./install.sh
```

## 步骤 4：开始安装

安装支持的参数说明如下：

| 变量名称                   | 默认值                | 是否必填       | 说明 |
| -------------------------- | ---------------------------- | -------|----------------------------------------------- |
| NAMESPACE                  |  zadig                       | 否    | Kubernetes 命名空间 |
| DOMAIN                      |        |和 IP 二选一  | 访问 Zadig 系统域名|
| IP                          |                              |和 DOMAIN 二选一  | Kubernetes 集群任一节点的外网 IP 地址，用于访问 Zadig 系统|
| PORT                         |                                        | 使用 IP 访问必填 | 30000 - 32767 任一端口 |
| STORAGE_CLASS              |                            | 否  | 若集群内支持持久存储卷，可以设置该变量，避免 Zadig 的数据库服务重启后数据丢失|
| MONGO_URI                  |                           | 否   | Zadig 业务数据存储，配置多个地址时需要进行转义，例如：mongodb://user:password@8.10.20.20\\,8.10.20.30。若不配置，使用安装脚本中内置的单节点 MongoDB |
| MONGO_DB                   |  zadig                     |否  | 数据库名称 |
| MYSQL_HOST                |""                          | 否  | Zadig 用户信息数据存储，若不配置，使用安装脚本中内置的单节点 MySQL|
| MYSQL_PORT                | ""                             | 否  | MySQL 数据库端口 |
| MYSQL_USERNAME            | ""                             | 否  | MySQL 数据库用户名 |
| MYSQL_PASSWORD            | ""                             | 否  | MySQL 数据库密码 |
| ENCRYPTION_KEY                     |                          | 否    | 由安装过程生成，用于数据加密解密，<font color=#FF000 >**第一次安装后请妥善保存**</font>。重装系统时需设置 ENCRYPTION_KEY，才能保证之前的数据可以被正确解密|
| EMAIL                      |  admin@example.com | 否 |初始用户邮箱 |
| PASSWORD                   |  zadig             | 否 |初始用户密码 |


```bash
# 以下变量可根据实际情况按需替换
export IP=1.1.1.1 # Kubernetes 集群任一节点的外网 IP 地址，用于访问 Zadig 系统
export PORT=30000 # 30000~32767 之间的任意一端口
export EMAIL=example@koderover.com
export PASSWORD=zadig
# 安装前需要手动在该 MySQL 实例中创建名为 dex 的 database
export MYSQL_HOST=10.0.2.249
export MYSQL_PORT=3306
export MYSQL_USERNAME=root
export MYSQL_PASSWORD="Mysql 密码"
./install.sh

```

## 步骤 6：验证安装结果

![预期安装结果](../../_images/install_success_new.png)

安装过程预计持续 10 分钟左右，受硬件配置和网络情况影响，不同环境下的时间可能不同，
当看到如图的输出时，说明安装已经完成，届时可以通过命令查看服务启动状态。

```bash
kubectl -n zadig get po
```
## 步骤 7：访问系统

![预期安装结果](../../_images/get_endpoint.png)

在安装结果输出中，您可以获得系统的访问地址。


## Zadig 卸载

支持使用脚本来一键卸载当前安装的 Zadig 系统，只需执行卸载脚本即可：

```bash
# 根据实际安装的 namespace 修改
export NAMESPACE=zadig
# 根据实际安装的版本，选择对应版本的卸载脚本
# 例如：卸载 v1.0.0 版本，执行以下卸载命令
curl -SsL https://github.com/koderover/zadig/releases/download/v1.0.0/uninstall.sh | bash
```

官方最新版卸载脚本：
```bash
curl -SsL https://download.koderover.com/install?type=uninstall | bash
```
