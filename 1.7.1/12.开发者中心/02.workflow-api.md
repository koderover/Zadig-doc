---
title: 工作流
date: 2021-03-19 09:32:04
permalink: /v1.7.1/api/workflow/
---

## 工作流任务重试

#### 注意事项

- 需要有工作流任务重试的权限；

#### 请求

```
POST /api/aslan/workflow/workflowtask/id/:id/pipelines/:pipeline/restart?projectName=:projectName
```

#### 路径参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`id`|int|任务 id|无|是|
|`pipelines`|string|工作流名称|无|是|
|`projectName`|string|工作流所属项目名称|无|否|

#### 正常返回

```json
{"message":"success"}
```

#### 异常返回
```json
{
  "code": 6164,
  "description": "获取工作流任务失败",
  "extra": {},
  "message": "重试工作流任务失败",
  "type": "error"
}
```

## 取消工作流任务

#### 注意事项

- 需要有取消工作流任务的权限；

#### 请求

```
DELETE /api/aslan/workflow/workflowtask/id/:id/pipelines/:pipeline?projectName=:projectName
```

#### 路径参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`id`|int|任务 id|无|是|
|`pipeline`|string|工作流名称|无|是|
|`projectName`|string|工作流所属项目|无|否|

#### 正常返回

```json
{"message":"success"}
```

#### 异常返回
```json
{
  "code": 6163,
  "description": "mongo: no documents in result",
  "extra": {},
  "message": "取消工作流任务失败",
  "type": "error"
}
```
## 创建工作流任务

#### 注意事项

- 需要有创建工作流任务的权限；
- 暂不支持更新环境变量；
- 暂不支持高级选项，如工作流空间缓存和 Docker 缓存。


#### 请求

```
POST /api/aslan/workflow/workflowtask?projectName=:projectName
```

#### body 参数样例

```json
{
  "workflow_name": "proxy-workflow-dev",
  "product_tmpl_name": "proxy",
  "namespace": "dev",
  "targets": [
    {
      "name": "proxy",
      "service_name": "proxy",
      "product_name": "proxy",
      "build": {
        "repos": [
          {
            "repo_name": "infra",
            "branch": "main",
            "pr": 1,
          },
          {
            "repo_name": "zadig",
            "branch": "main",
            "pr": 666,
          }
        ]
      },
    }
  ]
}

```

#### body 参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`workflow_name`|string|工作流名称|无|是|
|`product_tmpl_name`|string|工作流所属项目名称|无|是|
|`namespace`|string|更新部署的集成环境名称|无|是|
|`targets`|[]TargetArgs|工作流的构建部署配置|无|是|

#### TargetArgs 参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`name`|string|构建部署更新的服务组件名称|无|是|
|`service_name`|string|服务名称|无|是|
|`product_name`|string|项目名称|无|是|
|`build`|BuildArg|构建参数|无|是|

#### BuildArg 参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`repos`|[]Repository|关联代码库信息|无|是|

#### Repository 参数说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`repo_name`|string|代码库名称|无|是|
|`branch`|string|代码库分支|无|是|
|`pr`|int|代码库的 PR 号|0|使用 PR 构建时必填|


#### 正常返回

```json
{
  "pipeline_name": "proxy-workflow-dev",
  "task_id": 16 # 创建的工作流任务序号
}
```

#### 异常返回

```json
{
  "code": 6542,
  "description": "mongo: no documents in result",
  "extra": {},
  "message": "查询workflow失败",
  "type": "error"
}
```
